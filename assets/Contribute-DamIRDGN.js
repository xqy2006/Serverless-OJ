import{_ as H,e as v,n as J,f as j,l as W,c as T,a,w as n,r as d,o as _,d as h,g as N,b as g,i as O,F as Y,q as Q,u as X,v as Z,E as b,m as ee,t as te,x as oe,y as ae}from"./index-T7vEc1ET.js";import{e as k}from"./toggleHighContrast-CPgkQvnP.js";import{a as S}from"./axios-DXsv3KKR.js";const le={class:"contribute-container"},ne={class:"test-cases"},se={class:"test-case-header"},re="https://api.github.com",ue="xqy2006",ie="Serverless-OJ",de={__name:"Contribute",setup(me){const K=X(),w=v(null),x=v(null),E=v(!1),R=v(0),I=v([]),e=v({title:"",memoryLimit:256,timeLimit:1e3,difficulty:"easy",submitType:1,sourceCode:"",readme:"",testCases:[{input:"",output:""}]}),V={fontSize:14,minimap:{enabled:!1},scrollBeyondLastLine:!1,automaticLayout:!0,tabSize:2,language:"markdown",theme:"vs-light",wordWrap:"on",lineNumbers:"on",padding:{top:8,bottom:8}};let i=null,c=null;J(()=>e.value.submitType,l=>{l===1&&Z(()=>{i&&i.dispose(),i=k.create(w.value,{...V,language:"cpp",value:e.value.sourceCode}),i.onDidChangeModelContent(()=>{e.value.sourceCode=i.getValue()}),i.layout()})});const M=()=>{e.value.testCases.push({input:"",output:""})},z=l=>{e.value.testCases.length>1&&e.value.testCases.splice(l,1)};async function D(l){const s=await(await fetch("/public_key.pem")).text(),o=await crypto.subtle.importKey("spki",$(s),{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),r=await crypto.subtle.generateKey({name:"AES-CBC",length:256},!0,["encrypt"]),m=crypto.getRandomValues(new Uint8Array(16)),A=await crypto.subtle.exportKey("raw",r),p=await crypto.subtle.encrypt({name:"RSA-OAEP"},o,A),L=new TextEncoder().encode(l),y=await crypto.subtle.encrypt({name:"AES-CBC",iv:m},r,L),f=new Uint8Array(p.byteLength+m.byteLength+y.byteLength);return f.set(new Uint8Array(p),0),f.set(m,p.byteLength),f.set(new Uint8Array(y),p.byteLength+m.byteLength),btoa(String.fromCharCode(...f))}function $(l){const t=l.replace("-----BEGIN PUBLIC KEY-----","").replace("-----END PUBLIC KEY-----","").replace(/\s/g,""),s=atob(t),o=new Uint8Array(s.length);for(let r=0;r<s.length;r++)o[r]=s.charCodeAt(r);return o.buffer}async function q(l,t){const s=localStorage.getItem("github_token");if(!s)throw new Error("No GitHub token found");return(await S.post(`${re}/repos/${ue}/${ie}/issues`,{title:l,body:t},{headers:{Authorization:`token ${s}`,Accept:"application/vnd.github.v3+json"}})).data}const F=async()=>{if(!e.value.title.trim()||!e.value.readme.trim()){b.error("题目标题和描述不能为空");return}if(e.value.testCases.some(l=>!l.input.trim())){b.error("所有测试样例的输入不能为空");return}if(e.value.submitType===1&&!e.value.sourceCode.trim()){b.error("源代码不能为空");return}if(e.value.submitType===2&&e.value.testCases.some(l=>!l.output.trim())){b.error("所有测试样例的输出不能为空");return}E.value=!0;try{const l={id:R.value+1,title:e.value.title,memoryLimit:e.value.memoryLimit,timeLimit:e.value.timeLimit,difficulty:e.value.difficulty,author:ee().login};let t=JSON.stringify(l)+`
---SEPARATOR---
`;t+=e.value.readme+`
---SEPARATOR---
`,e.value.submitType===1?(t+=`---SOURCE---
`,t+=e.value.sourceCode+`
---INPUTS---
`,e.value.testCases.forEach((o,r)=>{t+=o.input+`
`,r<e.value.testCases.length-1&&(t+=`---CASE---
`)})):e.value.testCases.forEach((o,r)=>{t+=o.input+`
---OUTPUT---
`,t+=o.output,r<e.value.testCases.length-1&&(t+=`
---CASE---
`)});const s=await D(t);await q(`新题目提交: ${e.value.title}`,s),b.success("题目提交成功"),K.push("/")}catch(l){console.error("Failed to submit problem:",l),b.error("提交失败")}finally{E.value=!1}},G=async()=>{try{const t=(await S.get("/problems/list.txt")).data.split(`
`).filter(o=>o.trim()),s=await Promise.all(t.map(async o=>(await S.get(`/problems/${o}/problem.json`)).data));I.value=s.sort((o,r)=>r.id-o.id),R.value=s.length}catch(l){console.error("Failed to load problems:",l)}};j(()=>{G(),e.value.submitType===1&&(i=k.create(w.value,{...V,language:"cpp",value:e.value.sourceCode}),i.onDidChangeModelContent(()=>{e.value.sourceCode=i.getValue()})),c=k.create(x.value,{...V,language:"markdown",value:e.value.readme}),c.onDidChangeModelContent(()=>{e.value.readme=c.getValue()}),window.addEventListener("resize",B)});const B=()=>{i&&i.layout(),c&&c.layout()};return W(()=>{i&&i.dispose(),c&&c.dispose(),window.removeEventListener("resize",B)}),(l,t)=>{const s=d("el-input"),o=d("el-form-item"),r=d("el-input-number"),m=d("el-option"),A=d("el-select"),p=d("el-radio"),P=d("el-radio-group"),L=d("el-icon"),y=d("el-button"),f=d("el-form");return _(),T("div",le,[a(f,{model:e.value,"label-width":"120px"},{default:n(()=>[a(o,{label:"题目标题",required:""},{default:n(()=>[a(s,{modelValue:e.value.title,"onUpdate:modelValue":t[0]||(t[0]=u=>e.value.title=u),placeholder:"请输入题目标题"},null,8,["modelValue"])]),_:1}),a(o,{label:"内存限制(MB)"},{default:n(()=>[a(r,{modelValue:e.value.memoryLimit,"onUpdate:modelValue":t[1]||(t[1]=u=>e.value.memoryLimit=u),min:1,max:1024,"controls-position":"right"},null,8,["modelValue"])]),_:1}),a(o,{label:"时间限制(ms)"},{default:n(()=>[a(r,{modelValue:e.value.timeLimit,"onUpdate:modelValue":t[2]||(t[2]=u=>e.value.timeLimit=u),min:100,max:1e4,step:100,"controls-position":"right"},null,8,["modelValue"])]),_:1}),a(o,{label:"难度设置",required:""},{default:n(()=>[a(A,{modelValue:e.value.difficulty,"onUpdate:modelValue":t[3]||(t[3]=u=>e.value.difficulty=u),placeholder:"请选择题目难度"},{default:n(()=>[a(m,{label:"简单",value:"easy"}),a(m,{label:"中等",value:"medium"}),a(m,{label:"困难",value:"hard"})]),_:1},8,["modelValue"])]),_:1}),a(o,{label:"提交方式"},{default:n(()=>[a(P,{modelValue:e.value.submitType,"onUpdate:modelValue":t[4]||(t[4]=u=>e.value.submitType=u)},{default:n(()=>[a(p,{label:1},{default:n(()=>t[5]||(t[5]=[h("提供源代码")])),_:1}),a(p,{label:2},{default:n(()=>t[6]||(t[6]=[h("提供输入输出")])),_:1})]),_:1},8,["modelValue"])]),_:1}),e.value.submitType===1?(_(),N(o,{key:0,label:"源代码",required:""},{default:n(()=>[g("div",{class:"editor-container",ref_key:"sourceCodeEditorContainer",ref:w},null,512)]),_:1})):O("",!0),a(o,{label:"题目描述",required:""},{default:n(()=>[g("div",{class:"editor-container",ref_key:"readmeEditorContainer",ref:x},null,512)]),_:1}),a(o,{label:"测试样例"},{default:n(()=>[g("div",ne,[(_(!0),T(Y,null,Q(e.value.testCases,(u,U)=>(_(),T("div",{key:U,class:"test-case"},[g("div",se,[g("h4",null,"测试样例 #"+te(U+1),1),a(y,{type:"danger",size:"small",circle:"",onClick:C=>z(U),class:"remove-button",disabled:e.value.testCases.length<=1},{default:n(()=>[a(L,null,{default:n(()=>[a(oe(ae))]),_:1})]),_:2},1032,["onClick","disabled"])]),a(s,{modelValue:u.input,"onUpdate:modelValue":C=>u.input=C,type:"textarea",rows:4,placeholder:"输入样例"},null,8,["modelValue","onUpdate:modelValue"]),e.value.submitType===2?(_(),N(s,{key:0,modelValue:u.output,"onUpdate:modelValue":C=>u.output=C,type:"textarea",rows:4,placeholder:"输出样例",class:"output-textarea"},null,8,["modelValue","onUpdate:modelValue"])):O("",!0)]))),128))]),a(y,{type:"primary",onClick:M,class:"add-button"},{default:n(()=>t[7]||(t[7]=[h(" 添加测试样例 ")])),_:1})]),_:1}),a(o,null,{default:n(()=>[a(y,{type:"primary",onClick:F,loading:E.value},{default:n(()=>t[8]||(t[8]=[h(" 提交 ")])),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])])}}},fe=H(de,[["__scopeId","data-v-30b1d984"]]);export{fe as default};
