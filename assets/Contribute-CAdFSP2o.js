import{_ as D,e as C,n as $,f as F,l as G,c as T,a as o,w as n,r as d,o as b,d as h,g as R,b as _,i as N,F as H,q as J,u as W,v as Y,E as v,m as j,t as Q,x as X,y as Z}from"./index-DkI6-aSN.js";import{e as k}from"./toggleHighContrast-P5tVCn_H.js";import{a as ee}from"./axios-DXsv3KKR.js";const te={class:"contribute-container"},oe={class:"test-cases"},ae={class:"test-case-header"},le="https://api.github.com",ne="xqy2006",se="Serverless-OJ",re={__name:"Contribute",setup(ue){const O=W(),w=C(null),S=C(null),E=C(!1),e=C({title:"",memoryLimit:256,timeLimit:1e3,difficulty:"easy",submitType:1,sourceCode:"",readme:"",testCases:[{input:"",output:""}]}),V={fontSize:14,minimap:{enabled:!1},scrollBeyondLastLine:!1,automaticLayout:!0,tabSize:2,language:"markdown",theme:"vs-light",wordWrap:"on",lineNumbers:"on",padding:{top:8,bottom:8}};let i=null,c=null;$(()=>e.value.submitType,l=>{l===1&&Y(()=>{i&&i.dispose(),i=k.create(w.value,{...V,language:"cpp",value:e.value.sourceCode}),i.onDidChangeModelContent(()=>{e.value.sourceCode=i.getValue()}),i.layout()})});const P=()=>{e.value.testCases.push({input:"",output:""})},K=l=>{e.value.testCases.length>1&&e.value.testCases.splice(l,1)};async function I(l){const s=await(await fetch("/public_key.pem")).text(),a=await crypto.subtle.importKey("spki",M(s),{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),r=await crypto.subtle.generateKey({name:"AES-CBC",length:256},!0,["encrypt"]),m=crypto.getRandomValues(new Uint8Array(16)),A=await crypto.subtle.exportKey("raw",r),p=await crypto.subtle.encrypt({name:"RSA-OAEP"},a,A),L=new TextEncoder().encode(l),y=await crypto.subtle.encrypt({name:"AES-CBC",iv:m},r,L),f=new Uint8Array(p.byteLength+m.byteLength+y.byteLength);return f.set(new Uint8Array(p),0),f.set(m,p.byteLength),f.set(new Uint8Array(y),p.byteLength+m.byteLength),btoa(String.fromCharCode(...f))}function M(l){const t=l.replace("-----BEGIN PUBLIC KEY-----","").replace("-----END PUBLIC KEY-----","").replace(/\s/g,""),s=atob(t),a=new Uint8Array(s.length);for(let r=0;r<s.length;r++)a[r]=s.charCodeAt(r);return a.buffer}async function z(l,t){const s=localStorage.getItem("github_token");if(!s)throw new Error("No GitHub token found");return(await ee.post(`${le}/repos/${ne}/${se}/issues`,{title:l,body:t},{headers:{Authorization:`token ${s}`,Accept:"application/vnd.github.v3+json"}})).data}const q=async()=>{if(!e.value.title.trim()||!e.value.readme.trim()){v.error("题目标题和描述不能为空");return}if(e.value.testCases.some(l=>!l.input.trim())){v.error("所有测试样例的输入不能为空");return}if(e.value.submitType===1&&!e.value.sourceCode.trim()){v.error("源代码不能为空");return}if(e.value.submitType===2&&e.value.testCases.some(l=>!l.output.trim())){v.error("所有测试样例的输出不能为空");return}E.value=!0;try{const l={title:e.value.title,memoryLimit:e.value.memoryLimit,timeLimit:e.value.timeLimit,difficulty:e.value.difficulty,author:j().login};let t=JSON.stringify(l)+`
---SEPARATOR---
`;t+=e.value.readme+`
---SEPARATOR---
`,e.value.submitType===1?(t+=`---SOURCE---
`,t+=e.value.sourceCode+`
---INPUTS---
`,e.value.testCases.forEach((a,r)=>{t+=a.input+`
`,r<e.value.testCases.length-1&&(t+=`---CASE---
`)})):e.value.testCases.forEach((a,r)=>{t+=a.input+`
---OUTPUT---
`,t+=a.output,r<e.value.testCases.length-1&&(t+=`
---CASE---
`)});const s=await I(t);await z(`新题目提交: ${e.value.title}`,s),v.success("题目提交成功"),O.push("/")}catch(l){console.error("Failed to submit problem:",l),v.error("提交失败")}finally{E.value=!1}};F(()=>{e.value.submitType===1&&(i=k.create(w.value,{...V,language:"cpp",value:e.value.sourceCode}),i.onDidChangeModelContent(()=>{e.value.sourceCode=i.getValue()})),c=k.create(S.value,{...V,language:"markdown",value:e.value.readme}),c.onDidChangeModelContent(()=>{e.value.readme=c.getValue()}),window.addEventListener("resize",x)});const x=()=>{i&&i.layout(),c&&c.layout()};return G(()=>{i&&i.dispose(),c&&c.dispose(),window.removeEventListener("resize",x)}),(l,t)=>{const s=d("el-input"),a=d("el-form-item"),r=d("el-input-number"),m=d("el-option"),A=d("el-select"),p=d("el-radio"),B=d("el-radio-group"),L=d("el-icon"),y=d("el-button"),f=d("el-form");return b(),T("div",te,[o(f,{model:e.value,"label-width":"120px"},{default:n(()=>[o(a,{label:"题目标题",required:""},{default:n(()=>[o(s,{modelValue:e.value.title,"onUpdate:modelValue":t[0]||(t[0]=u=>e.value.title=u),placeholder:"请输入题目标题"},null,8,["modelValue"])]),_:1}),o(a,{label:"内存限制(MB)"},{default:n(()=>[o(r,{modelValue:e.value.memoryLimit,"onUpdate:modelValue":t[1]||(t[1]=u=>e.value.memoryLimit=u),min:1,max:1024,"controls-position":"right"},null,8,["modelValue"])]),_:1}),o(a,{label:"时间限制(ms)"},{default:n(()=>[o(r,{modelValue:e.value.timeLimit,"onUpdate:modelValue":t[2]||(t[2]=u=>e.value.timeLimit=u),min:100,max:1e4,step:100,"controls-position":"right"},null,8,["modelValue"])]),_:1}),o(a,{label:"难度设置",required:""},{default:n(()=>[o(A,{modelValue:e.value.difficulty,"onUpdate:modelValue":t[3]||(t[3]=u=>e.value.difficulty=u),placeholder:"请选择题目难度"},{default:n(()=>[o(m,{label:"简单",value:"easy"}),o(m,{label:"中等",value:"medium"}),o(m,{label:"困难",value:"hard"})]),_:1},8,["modelValue"])]),_:1}),o(a,{label:"提交方式"},{default:n(()=>[o(B,{modelValue:e.value.submitType,"onUpdate:modelValue":t[4]||(t[4]=u=>e.value.submitType=u)},{default:n(()=>[o(p,{label:1},{default:n(()=>t[5]||(t[5]=[h("提供源代码")])),_:1}),o(p,{label:2},{default:n(()=>t[6]||(t[6]=[h("提供输入输出")])),_:1})]),_:1},8,["modelValue"])]),_:1}),e.value.submitType===1?(b(),R(a,{key:0,label:"源代码",required:""},{default:n(()=>[_("div",{class:"editor-container",ref_key:"sourceCodeEditorContainer",ref:w},null,512)]),_:1})):N("",!0),o(a,{label:"题目描述",required:""},{default:n(()=>[_("div",{class:"editor-container",ref_key:"readmeEditorContainer",ref:S},null,512)]),_:1}),o(a,{label:"测试样例"},{default:n(()=>[_("div",oe,[(b(!0),T(H,null,J(e.value.testCases,(u,U)=>(b(),T("div",{key:U,class:"test-case"},[_("div",ae,[_("h4",null,"测试样例 #"+Q(U+1),1),o(y,{type:"danger",size:"small",circle:"",onClick:g=>K(U),class:"remove-button",disabled:e.value.testCases.length<=1},{default:n(()=>[o(L,null,{default:n(()=>[o(X(Z))]),_:1})]),_:2},1032,["onClick","disabled"])]),o(s,{modelValue:u.input,"onUpdate:modelValue":g=>u.input=g,type:"textarea",rows:4,placeholder:"输入样例"},null,8,["modelValue","onUpdate:modelValue"]),e.value.submitType===2?(b(),R(s,{key:0,modelValue:u.output,"onUpdate:modelValue":g=>u.output=g,type:"textarea",rows:4,placeholder:"输出样例",class:"output-textarea"},null,8,["modelValue","onUpdate:modelValue"])):N("",!0)]))),128))]),o(y,{type:"primary",onClick:P,class:"add-button"},{default:n(()=>t[7]||(t[7]=[h(" 添加测试样例 ")])),_:1})]),_:1}),o(a,null,{default:n(()=>[o(y,{type:"primary",onClick:q,loading:E.value},{default:n(()=>t[8]||(t[8]=[h(" 提交 ")])),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])])}}},ce=D(re,[["__scopeId","data-v-7c15c821"]]);export{ce as default};
