import{_ as j,e as v,p as J,f as W,l as Y,c as T,a as o,w as r,r as c,o as _,d as w,g as P,b as C,i as O,F as Q,v as X,u as Z,x as ee,E as g,n as te,t as oe,y as ae,z as le}from"./index-B1-eFAnh.js";import{e as S}from"./toggleHighContrast-vI9AEEj7.js";import{a as E}from"./axios-DXsv3KKR.js";const ne={class:"contribute-container"},se={class:"test-cases"},re={class:"test-case-header"},ie="https://api.github.com",ue="xqy2006",de="Serverless-OJ",ce={__name:"Contribute",setup(me){const I=Z(),V=v(null),x=v(null),A=v(!1),R=v(0),K=v([]),e=v({title:"",memoryLimit:256,timeLimit:1e3,difficulty:"easy",submitType:1,sourceCode:"",readme:"",testCases:[{input:"",output:""}]}),k={fontSize:14,minimap:{enabled:!1},scrollBeyondLastLine:!1,automaticLayout:!0,tabSize:2,language:"markdown",theme:"vs-light",wordWrap:"on",lineNumbers:"on",padding:{top:8,bottom:8}};let u=null,m=null;J(()=>e.value.submitType,l=>{l===1&&ee(()=>{u&&u.dispose(),u=S.create(V.value,{...k,language:"cpp",value:e.value.sourceCode}),u.onDidChangeModelContent(()=>{e.value.sourceCode=u.getValue()}),u.layout()})});const z=()=>{e.value.testCases.push({input:"",output:""})},D=l=>{e.value.testCases.length>1&&e.value.testCases.splice(l,1)};async function M(l){const n=await(await fetch("/public_key.pem")).text(),a=await crypto.subtle.importKey("spki",$(n),{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),s=await crypto.subtle.generateKey({name:"AES-CBC",length:256},!0,["encrypt"]),d=crypto.getRandomValues(new Uint8Array(16)),L=await crypto.subtle.exportKey("raw",s),p=await crypto.subtle.encrypt({name:"RSA-OAEP"},a,L),U=new TextEncoder().encode(l),b=await crypto.subtle.encrypt({name:"AES-CBC",iv:d},s,U),y=new Uint8Array(p.byteLength+d.byteLength+b.byteLength);y.set(new Uint8Array(p),0),y.set(d,p.byteLength),y.set(new Uint8Array(b),p.byteLength+d.byteLength);let i="";for(let f=0;f<y.length;f++)i+=String.fromCharCode(y[f]);return btoa(i)}function $(l){const t=l.replace("-----BEGIN PUBLIC KEY-----","").replace("-----END PUBLIC KEY-----","").replace(/\s/g,""),n=atob(t),a=new Uint8Array(n.length);for(let s=0;s<n.length;s++)a[s]=n.charCodeAt(s);return a.buffer}async function q(l,t){const n=localStorage.getItem("github_token");if(!n)throw new Error("No GitHub token found");return(await E.post("https://api.github.com/gists",{description:l,public:!0,files:{"problem-description.md":{content:t}}},{headers:{Authorization:`token ${n}`,Accept:"application/vnd.github.v3+json"}})).data}async function G(l,t){const n=localStorage.getItem("github_token");if(!n)throw new Error("No GitHub token found");return(await E.post(`${ie}/repos/${ue}/${de}/issues`,{title:l,body:t},{headers:{Authorization:`token ${n}`,Accept:"application/vnd.github.v3+json"}})).data}const F=async()=>{if(!e.value.title.trim()||!e.value.readme.trim()){g.error("题目标题和描述不能为空");return}if(e.value.testCases.some(l=>!l.input.trim())){g.error("所有测试样例的输入不能为空");return}if(e.value.submitType===1&&!e.value.sourceCode.trim()){g.error("源代码不能为空");return}if(e.value.submitType===2&&e.value.testCases.some(l=>!l.output.trim())){g.error("所有测试样例的输出不能为空");return}A.value=!0;try{const l={id:R.value+1,title:e.value.title,memoryLimit:e.value.memoryLimit,timeLimit:e.value.timeLimit,difficulty:e.value.difficulty,author:te().login};let t=JSON.stringify(l)+`
---SEPARATOR---
`;t+=e.value.readme+`
---SEPARATOR---
`,e.value.submitType===1?(t+=`---SOURCE---
`,t+=e.value.sourceCode+`
---INPUTS---
`,e.value.testCases.forEach((s,d)=>{t+=s.input+`
`,d<e.value.testCases.length-1&&(t+=`---CASE---
`)})):e.value.testCases.forEach((s,d)=>{t+=s.input+`
---OUTPUT---
`,t+=s.output,d<e.value.testCases.length-1&&(t+=`
---CASE---
`)});const n=await M(t),a=await q(e.value.title,n);await G(`新题目提交: ${e.value.title}`,a.files["problem-description.md"].raw_url),g.success("题目提交成功"),I.push("/")}catch(l){console.error("Failed to submit problem:",l),g.error("提交失败")}finally{A.value=!1}},H=async()=>{try{const t=(await E.get("/problems/list.txt")).data.split(`
`).filter(a=>a.trim()),n=await Promise.all(t.map(async a=>(await E.get(`/problems/${a}/problem.json`)).data));K.value=n.sort((a,s)=>s.id-a.id),R.value=n.length}catch(l){console.error("Failed to load problems:",l)}};W(()=>{H(),e.value.submitType===1&&(u=S.create(V.value,{...k,language:"cpp",value:e.value.sourceCode}),u.onDidChangeModelContent(()=>{e.value.sourceCode=u.getValue()})),m=S.create(x.value,{...k,language:"markdown",value:e.value.readme}),m.onDidChangeModelContent(()=>{e.value.readme=m.getValue()}),window.addEventListener("resize",B)});const B=()=>{u&&u.layout(),m&&m.layout()};return Y(()=>{u&&u.dispose(),m&&m.dispose(),window.removeEventListener("resize",B)}),(l,t)=>{const n=c("el-input"),a=c("el-form-item"),s=c("el-input-number"),d=c("el-option"),L=c("el-select"),p=c("el-radio"),N=c("el-radio-group"),U=c("el-icon"),b=c("el-button"),y=c("el-form");return _(),T("div",ne,[o(y,{model:e.value,"label-width":"120px"},{default:r(()=>[o(a,{label:"题目标题",required:""},{default:r(()=>[o(n,{modelValue:e.value.title,"onUpdate:modelValue":t[0]||(t[0]=i=>e.value.title=i),placeholder:"请输入题目标题"},null,8,["modelValue"])]),_:1}),o(a,{label:"内存限制(MB)"},{default:r(()=>[o(s,{modelValue:e.value.memoryLimit,"onUpdate:modelValue":t[1]||(t[1]=i=>e.value.memoryLimit=i),min:1,max:1024,"controls-position":"right"},null,8,["modelValue"])]),_:1}),o(a,{label:"时间限制(ms)"},{default:r(()=>[o(s,{modelValue:e.value.timeLimit,"onUpdate:modelValue":t[2]||(t[2]=i=>e.value.timeLimit=i),min:100,max:1e4,step:100,"controls-position":"right"},null,8,["modelValue"])]),_:1}),o(a,{label:"难度设置",required:""},{default:r(()=>[o(L,{modelValue:e.value.difficulty,"onUpdate:modelValue":t[3]||(t[3]=i=>e.value.difficulty=i),placeholder:"请选择题目难度"},{default:r(()=>[o(d,{label:"简单",value:"easy"}),o(d,{label:"中等",value:"medium"}),o(d,{label:"困难",value:"hard"})]),_:1},8,["modelValue"])]),_:1}),o(a,{label:"提交方式"},{default:r(()=>[o(N,{modelValue:e.value.submitType,"onUpdate:modelValue":t[4]||(t[4]=i=>e.value.submitType=i)},{default:r(()=>[o(p,{label:1},{default:r(()=>t[5]||(t[5]=[w("提供源代码")])),_:1}),o(p,{label:2},{default:r(()=>t[6]||(t[6]=[w("提供输入输出")])),_:1})]),_:1},8,["modelValue"])]),_:1}),e.value.submitType===1?(_(),P(a,{key:0,label:"源代码",required:""},{default:r(()=>[C("div",{class:"editor-container",ref_key:"sourceCodeEditorContainer",ref:V},null,512)]),_:1})):O("",!0),o(a,{label:"题目描述",required:""},{default:r(()=>[C("div",{class:"editor-container",ref_key:"readmeEditorContainer",ref:x},null,512)]),_:1}),o(a,{label:"测试样例"},{default:r(()=>[C("div",se,[(_(!0),T(Q,null,X(e.value.testCases,(i,f)=>(_(),T("div",{key:f,class:"test-case"},[C("div",re,[C("h4",null,"测试样例 #"+oe(f+1),1),o(b,{type:"danger",size:"small",circle:"",onClick:h=>D(f),class:"remove-button",disabled:e.value.testCases.length<=1},{default:r(()=>[o(U,null,{default:r(()=>[o(ae(le))]),_:1})]),_:2},1032,["onClick","disabled"])]),o(n,{modelValue:i.input,"onUpdate:modelValue":h=>i.input=h,type:"textarea",rows:4,placeholder:"输入样例"},null,8,["modelValue","onUpdate:modelValue"]),e.value.submitType===2?(_(),P(n,{key:0,modelValue:i.output,"onUpdate:modelValue":h=>i.output=h,type:"textarea",rows:4,placeholder:"输出样例",class:"output-textarea"},null,8,["modelValue","onUpdate:modelValue"])):O("",!0)]))),128))]),o(b,{type:"primary",onClick:z,class:"add-button"},{default:r(()=>t[7]||(t[7]=[w(" 添加测试样例 ")])),_:1})]),_:1}),o(a,null,{default:r(()=>[o(b,{type:"primary",onClick:F,loading:A.value},{default:r(()=>t[8]||(t[8]=[w(" 提交 ")])),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])])}}},be=j(ce,[["__scopeId","data-v-81e4d49a"]]);export{be as default};
