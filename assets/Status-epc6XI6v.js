import{_ as ee,e as p,k as W,q as te,f as ae,v as le,c as oe,a as s,w as c,r as d,o as se,b as C,d as V,t as A,p as j}from"./index-CQxZ86EF.js";import{a as G}from"./axios-DXsv3KKR.js";const ne={class:"status"},re={class:"header"},ue={class:"filters"},ie=["href"],ce=["href"],de={class:"pagination"},H="xqy2006",B="Serverless-OJ",pe={__name:"Status",setup(me){const v=p(""),f=p(""),_=p(1),i=p(10),L=p(0),g=p([]),z=p([]),P=p(!1),I=p(!1),R=p(0),x=p(!1),S=localStorage.getItem("github_token");let T=null;const b=JSON.parse(localStorage.getItem("problemIdCache"))||{},y={},U=async t=>{const e=k(t.title);return b[e]?b[e]:y[e]?(await y[e],b[e]):(y[e]=G.get(`/problems/${e}/problem.json`).then(a=>{const l=a.data.id;b[e]=l,localStorage.setItem("problemIdCache",JSON.stringify(b))}).catch(a=>{console.error("获取问题 ID 失败:",a),b[e]=null}).finally(()=>{delete y[e]}),await y[e],b[e])},k=t=>t.slice(0,-2),$=async(t=1,e=100)=>{try{const a=`repo:${H}/${B} is:issue "评测" in:title`,l={Accept:"application/vnd.github.v3+json",...S&&{Authorization:`token ${S}`}},o=await fetch(`https://api.github.com/search/issues?q=${encodeURIComponent(a)}&page=${t}&per_page=${e}&sort=created&order=desc`,{headers:l});if(!o.ok)throw new Error("Network response was not ok");const u=await o.json();return{items:u.items,total:u.total_count}}catch(a){return console.error("获取提交记录失败:",a),{items:[],total:0}}},D=async(t=!1)=>{try{P.value=!0;const{total:e}=await $(1,1),a=e!==L.value;if(!a&&!t){await O();return}L.value=e;const l=(_.value-1)*i.value,o=l+i.value,u=Math.floor(l/i.value)+1,n=Math.ceil(o/i.value);let m=[];for(let w=u;w<=n;w++){const M=await $(w,i.value);m=[...m,...M.items]}const h=m.slice(l-(u-1)*i.value,o-(u-1)*i.value),E=await Promise.all(h.map(w=>U(w))),N=await J(h,E);g.value=N,!x.value&&a&&Q(n+1)}catch(e){console.error("获取提交记录失败:",e)}finally{P.value=!1}},J=async(t,e)=>t.filter(a=>a.title.endsWith("评测")).map((a,l)=>{var o;return{id:String(a.number),problemId:e[l],html_url:a.html_url,problem:k(a.title),user:a.user.login,result:((o=a.labels.find(u=>["AC","WA","CE","RE","TLE","MLE","CHEATING"].includes(u.name)))==null?void 0:o.name)||"评测中",submitTime:new Date(a.created_at).toLocaleString()}}),O=async()=>{const t=q.value,e=await Promise.all(t.map(async l=>{var o;try{const n=((o=(await G.get(`https://api.github.com/repos/${H}/${B}/issues/${l.id}`,{headers:{Authorization:`token ${S}`,Accept:"application/vnd.github.v3+json"}})).data.labels.find(m=>["AC","WA","CE","RE","TLE","MLE","CHEATING"].includes(m.name)))==null?void 0:o.name)||"评测中";return{...l,result:n}}catch(u){return console.error(`更新Issue ${l.id}状态失败:`,u),l}})),a=[...g.value];e.forEach(l=>{const o=a.findIndex(u=>u.id===l.id);o!==-1&&(a[o]=l)}),g.value=a},Q=async t=>{try{x.value=!0;const e=Math.ceil(L.value/i.value);for(let a=t;a<=e;a++){const l=await $(a,i.value),o=await Promise.all(l.items.map(n=>U(n))),u=l.items.filter(n=>n.title.endsWith("评测")).map((n,m)=>{var h;return{id:String(n.number),problemId:o[m],html_url:n.html_url,problem:k(n.title),user:n.user.login,result:((h=n.labels.find(E=>["AC","WA","CE","RE","TLE","MLE","CHEATING"].includes(E.name)))==null?void 0:h.name)||"评测中",submitTime:new Date(n.created_at).toLocaleString()}});g.value=[...g.value,...u],R.value=Math.round((a-t+1)/(e-t+1)*100)}}catch(e){console.error("加载剩余数据失败:",e)}finally{x.value=!1,R.value=100}},q=W(()=>{let t=[...g.value];if(f.value&&(t=t.filter(l=>l.result===f.value)),v.value){const l=v.value.toLowerCase();t=t.filter(o=>o.problem.toLowerCase().includes(l)||o.id.includes(l)||o.user.toLowerCase().includes(l))}if(I.value){const l=j().login;t=t.filter(o=>o.user===l)}const e=(_.value-1)*i.value,a=e+i.value;return z.value=t.slice(e,a),z.value}),K=W(()=>{let t=[...g.value];if(f.value&&(t=t.filter(e=>e.result===f.value)),v.value){const e=v.value.toLowerCase();t=t.filter(a=>a.problem.toLowerCase().includes(e)||a.id.includes(e)||a.user.toLowerCase().includes(e))}if(I.value){const e=j().login;t=t.filter(a=>a.user===e)}return t.length});te([v,f,I],()=>{_.value=1});const X=t=>{i.value=t,_.value=1},Y=t=>{_.value=t},Z=t=>({AC:"success",CE:"info",RE:"danger",TLE:"warning",MLE:"primary",CHEATING:"danger",WA:"danger",评测中:""})[t];return ae(()=>{D(!0),S&&(T=setInterval(()=>{D(!1)},1e4))}),le(()=>{T&&clearInterval(T)}),(t,e)=>{const a=d("el-input"),l=d("el-option"),o=d("el-select"),u=d("el-checkbox"),n=d("el-table-column"),m=d("router-link"),h=d("el-tag"),E=d("el-table"),N=d("el-pagination"),w=d("el-card"),M=d("el-col"),F=d("el-row");return se(),oe("div",ne,[s(F,{justify:"center"},{default:c(()=>[s(M,{xs:24,sm:22,md:20},{default:c(()=>[s(w,{class:"status-card"},{header:c(()=>[C("div",re,[e[6]||(e[6]=C("h2",null,"评测状态",-1)),C("div",ue,[s(a,{modelValue:v.value,"onUpdate:modelValue":e[0]||(e[0]=r=>v.value=r),placeholder:"搜索题目/提交ID/用户","prefix-icon":"Search",class:"filter-item"},null,8,["modelValue"]),s(o,{modelValue:f.value,"onUpdate:modelValue":e[1]||(e[1]=r=>f.value=r),placeholder:"评测结果",class:"filter-item"},{default:c(()=>[s(l,{label:"全部",value:""}),s(l,{label:"通过",value:"AC"}),s(l,{label:"答案错误",value:"WA"}),s(l,{label:"编译错误",value:"CE"}),s(l,{label:"运行错误",value:"RE"}),s(l,{label:"超时",value:"TLE"}),s(l,{label:"内存超限",value:"MLE"}),s(l,{label:"作弊",value:"CHEATING"})]),_:1},8,["modelValue"]),s(u,{modelValue:I.value,"onUpdate:modelValue":e[2]||(e[2]=r=>I.value=r),class:"filter-item"},{default:c(()=>e[5]||(e[5]=[V(" 只看我的 ")])),_:1},8,["modelValue"])])])]),default:c(()=>[s(E,{data:q.value,style:{width:"100%"},class:"responsive-table"},{default:c(()=>[s(n,{prop:"id",label:"提交ID","min-width":"90"},{default:c(r=>[C("a",{href:r.row.html_url,target:"_blank"},A(r.row.id),9,ie)]),_:1}),s(n,{prop:"problem",label:"题目","min-width":"120"},{default:c(r=>[s(m,{to:`/submit/${r.row.problemId}`},{default:c(()=>[V(A(r.row.problem),1)]),_:2},1032,["to"])]),_:1}),s(n,{prop:"result",label:"结果","min-width":"90"},{default:c(r=>[s(h,{type:Z(r.row.result)},{default:c(()=>[V(A(r.row.result),1)]),_:2},1032,["type"])]),_:1}),s(n,{prop:"user",label:"提交用户","min-width":"100"},{default:c(r=>[C("a",{href:`https://github.com/${r.row.user}`,target:"_blank"},A(r.row.user),9,ce)]),_:1}),s(n,{prop:"submitTime",label:"提交时间","min-width":"160"})]),_:1},8,["data"]),C("div",de,[s(N,{"current-page":_.value,"onUpdate:currentPage":e[3]||(e[3]=r=>_.value=r),"page-size":i.value,"onUpdate:pageSize":e[4]||(e[4]=r=>i.value=r),total:K.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next",onSizeChange:X,onCurrentChange:Y,class:"responsive-pagination"},null,8,["current-page","page-size","total"])])]),_:1})]),_:1})]),_:1})])}}},_e=ee(pe,[["__scopeId","data-v-db99f3f0"]]);export{_e as default};
