import{_ as z,e as C,n as D,f as $,l as q,c as U,a as o,w as n,r as m,o as v,d as h,g as x,b,i as B,F,q as G,u as H,v as J,E as f,m as W,t as Y,x as j,y as Q}from"./index-J5f_yb-1.js";import{e as T}from"./toggleHighContrast-BXqKFmGk.js";import{a as X}from"./axios-DXsv3KKR.js";const Z={class:"contribute-container"},ee={class:"test-cases"},te={class:"test-case-header"},oe="https://api.github.com",ae="xqy2006",le="Serverless-OJ",ne={__name:"Contribute",setup(re){const R=H(),w=C(null),k=C(null),E=C(!1),e=C({title:"",memoryLimit:256,timeLimit:1e3,submitType:1,sourceCode:"",readme:"",testCases:[{input:"",output:""}]}),V={fontSize:14,minimap:{enabled:!1},scrollBeyondLastLine:!1,automaticLayout:!0,tabSize:2,language:"markdown",theme:"vs-light",wordWrap:"on",lineNumbers:"on",padding:{top:8,bottom:8}};let i=null,c=null;D(()=>e.value.submitType,l=>{l===1&&J(()=>{i&&i.dispose(),i=T.create(w.value,{...V,language:"cpp",value:e.value.sourceCode}),i.onDidChangeModelContent(()=>{e.value.sourceCode=i.getValue()}),i.layout()})});const N=()=>{e.value.testCases.push({input:"",output:""})},O=l=>{e.value.testCases.length>1&&e.value.testCases.splice(l,1)};async function P(l){const s=await(await fetch("/public_key.pem")).text(),a=await crypto.subtle.importKey("spki",K(s),{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),u=await crypto.subtle.generateKey({name:"AES-CBC",length:256},!0,["encrypt"]),p=crypto.getRandomValues(new Uint8Array(16)),A=await crypto.subtle.exportKey("raw",u),y=await crypto.subtle.encrypt({name:"RSA-OAEP"},a,A),L=new TextEncoder().encode(l),r=await crypto.subtle.encrypt({name:"AES-CBC",iv:p},u,L),d=new Uint8Array(y.byteLength+p.byteLength+r.byteLength);return d.set(new Uint8Array(y),0),d.set(p,y.byteLength),d.set(new Uint8Array(r),y.byteLength+p.byteLength),btoa(String.fromCharCode(...d))}function K(l){const t=l.replace("-----BEGIN PUBLIC KEY-----","").replace("-----END PUBLIC KEY-----","").replace(/\s/g,""),s=atob(t),a=new Uint8Array(s.length);for(let u=0;u<s.length;u++)a[u]=s.charCodeAt(u);return a.buffer}async function I(l,t){const s=localStorage.getItem("github_token");if(!s)throw new Error("No GitHub token found");return(await X.post(`${oe}/repos/${ae}/${le}/issues`,{title:l,body:t},{headers:{Authorization:`token ${s}`,Accept:"application/vnd.github.v3+json"}})).data}const M=async()=>{if(!e.value.title.trim()||!e.value.readme.trim()){f.error("题目标题和描述不能为空");return}if(e.value.testCases.some(l=>!l.input.trim())){f.error("所有测试样例的输入不能为空");return}if(e.value.submitType===1&&!e.value.sourceCode.trim()){f.error("源代码不能为空");return}if(e.value.submitType===2&&e.value.testCases.some(l=>!l.output.trim())){f.error("所有测试样例的输出不能为空");return}E.value=!0;try{const l={title:e.value.title,memoryLimit:e.value.memoryLimit,timeLimit:e.value.timeLimit,author:W().login};let t=JSON.stringify(l)+`
---SEPARATOR---
`;t+=e.value.readme+`
---SEPARATOR---
`,e.value.submitType===1?(t+=`---SOURCE---
`,t+=e.value.sourceCode+`
---INPUTS---
`,e.value.testCases.forEach((a,u)=>{t+=a.input+`
`,u<e.value.testCases.length-1&&(t+=`---CASE---
`)})):e.value.testCases.forEach((a,u)=>{t+=a.input+`
---OUTPUT---
`,t+=a.output,u<e.value.testCases.length-1&&(t+=`
---CASE---
`)});const s=await P(t);await I(`新题目提交: ${e.value.title}`,s),f.success("题目提交成功"),R.push("/")}catch(l){console.error("Failed to submit problem:",l),f.error("提交失败")}finally{E.value=!1}};$(()=>{e.value.submitType===1&&(i=T.create(w.value,{...V,language:"cpp",value:e.value.sourceCode}),i.onDidChangeModelContent(()=>{e.value.sourceCode=i.getValue()})),c=T.create(k.value,{...V,language:"markdown",value:e.value.readme}),c.onDidChangeModelContent(()=>{e.value.readme=c.getValue()}),window.addEventListener("resize",S)});const S=()=>{i&&i.layout(),c&&c.layout()};return q(()=>{i&&i.dispose(),c&&c.dispose(),window.removeEventListener("resize",S)}),(l,t)=>{const s=m("el-input"),a=m("el-form-item"),u=m("el-input-number"),p=m("el-radio"),A=m("el-radio-group"),y=m("el-icon"),_=m("el-button"),L=m("el-form");return v(),U("div",Z,[o(L,{model:e.value,"label-width":"120px"},{default:n(()=>[o(a,{label:"题目标题",required:""},{default:n(()=>[o(s,{modelValue:e.value.title,"onUpdate:modelValue":t[0]||(t[0]=r=>e.value.title=r),placeholder:"请输入题目标题"},null,8,["modelValue"])]),_:1}),o(a,{label:"内存限制(MB)"},{default:n(()=>[o(u,{modelValue:e.value.memoryLimit,"onUpdate:modelValue":t[1]||(t[1]=r=>e.value.memoryLimit=r),min:1,max:1024,"controls-position":"right"},null,8,["modelValue"])]),_:1}),o(a,{label:"时间限制(ms)"},{default:n(()=>[o(u,{modelValue:e.value.timeLimit,"onUpdate:modelValue":t[2]||(t[2]=r=>e.value.timeLimit=r),min:100,max:1e4,step:100,"controls-position":"right"},null,8,["modelValue"])]),_:1}),o(a,{label:"提交方式"},{default:n(()=>[o(A,{modelValue:e.value.submitType,"onUpdate:modelValue":t[3]||(t[3]=r=>e.value.submitType=r)},{default:n(()=>[o(p,{label:1},{default:n(()=>t[4]||(t[4]=[h("提供源代码")])),_:1}),o(p,{label:2},{default:n(()=>t[5]||(t[5]=[h("提供输入输出")])),_:1})]),_:1},8,["modelValue"])]),_:1}),e.value.submitType===1?(v(),x(a,{key:0,label:"源代码",required:""},{default:n(()=>[b("div",{class:"editor-container",ref_key:"sourceCodeEditorContainer",ref:w},null,512)]),_:1})):B("",!0),o(a,{label:"题目描述",required:""},{default:n(()=>[b("div",{class:"editor-container",ref_key:"readmeEditorContainer",ref:k},null,512)]),_:1}),o(a,{label:"测试样例"},{default:n(()=>[b("div",ee,[(v(!0),U(F,null,G(e.value.testCases,(r,d)=>(v(),U("div",{key:d,class:"test-case"},[b("div",te,[b("h4",null,"测试样例 #"+Y(d+1),1),o(_,{type:"danger",size:"small",circle:"",onClick:g=>O(d),class:"remove-button",disabled:e.value.testCases.length<=1},{default:n(()=>[o(y,null,{default:n(()=>[o(j(Q))]),_:1})]),_:2},1032,["onClick","disabled"])]),o(s,{modelValue:r.input,"onUpdate:modelValue":g=>r.input=g,type:"textarea",rows:4,placeholder:"输入样例"},null,8,["modelValue","onUpdate:modelValue"]),e.value.submitType===2?(v(),x(s,{key:0,modelValue:r.output,"onUpdate:modelValue":g=>r.output=g,type:"textarea",rows:4,placeholder:"输出样例",class:"output-textarea"},null,8,["modelValue","onUpdate:modelValue"])):B("",!0)]))),128))]),o(_,{type:"primary",onClick:N,class:"add-button"},{default:n(()=>t[6]||(t[6]=[h(" 添加测试样例 ")])),_:1})]),_:1}),o(a,null,{default:n(()=>[o(_,{type:"primary",onClick:M,loading:E.value},{default:n(()=>t[7]||(t[7]=[h(" 提交 ")])),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])])}}},de=z(ne,[["__scopeId","data-v-3f779a4c"]]);export{de as default};
