import{_ as X,e as y,p as z,f as Z,l as ee,c as R,a,w as u,r as c,o as b,d as V,g as x,b as g,i as B,F as te,v as ae,u as le,x as D,E as _,n as oe,t as ne,y as se,z as ue}from"./index-D-JPBvNk.js";import{e as S}from"./toggleHighContrast-B2LSA0Te.js";import{a as A}from"./axios-DXsv3KKR.js";const re={class:"contribute-container"},ie={class:"test-cases"},de={class:"test-case-header"},ce="https://api.github.com",pe="xqy2006",me="Serverless-OJ",fe={__name:"Contribute",setup(ve){const M=le(),k=y(null),P=y(null),L=y(!1),N=y(0),$=y([]),e=y({title:"",memoryLimit:256,timeLimit:1e3,difficulty:"easy",submitType:1,useSpecialJudge:!1,specialJudgeCode:"",sourceCode:"",readme:"",testCases:[{input:"",output:""}]}),C={fontSize:14,minimap:{enabled:!1},scrollBeyondLastLine:!1,automaticLayout:!0,tabSize:2,language:"markdown",theme:"vs-light",wordWrap:"on",lineNumbers:"on",padding:{top:8,bottom:8}},O=y(null);let p=null,i=null,f=null;z(()=>e.value.useSpecialJudge,o=>{o&&D(()=>{p&&p.dispose(),p=S.create(O.value,{...C,language:"cpp",value:e.value.specialJudgeCode}),p.onDidChangeModelContent(()=>{e.value.specialJudgeCode=p.getValue()}),p.layout()})}),z(()=>e.value.submitType,o=>{o===1&&D(()=>{i&&i.dispose(),i=S.create(k.value,{...C,language:"cpp",value:e.value.sourceCode}),i.onDidChangeModelContent(()=>{e.value.sourceCode=i.getValue()}),i.layout()})});const q=()=>{e.value.testCases.push({input:"",output:""})},G=o=>{e.value.testCases.length>1&&e.value.testCases.splice(o,1)};async function F(o){const n=await(await fetch("/public_key.pem")).text(),l=await crypto.subtle.importKey("spki",H(n),{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),r=await crypto.subtle.generateKey({name:"AES-CBC",length:256},!0,["encrypt"]),d=crypto.getRandomValues(new Uint8Array(16)),U=await crypto.subtle.exportKey("raw",r),v=await crypto.subtle.encrypt({name:"RSA-OAEP"},l,U),T=new TextEncoder().encode(o),h=await crypto.subtle.encrypt({name:"AES-CBC",iv:d},r,T),m=new Uint8Array(v.byteLength+d.byteLength+h.byteLength);m.set(new Uint8Array(v),0),m.set(d,v.byteLength),m.set(new Uint8Array(h),v.byteLength+d.byteLength);let w="";for(let s=0;s<m.length;s++)w+=String.fromCharCode(m[s]);return btoa(w)}function H(o){const t=o.replace("-----BEGIN PUBLIC KEY-----","").replace("-----END PUBLIC KEY-----","").replace(/\s/g,""),n=atob(t),l=new Uint8Array(n.length);for(let r=0;r<n.length;r++)l[r]=n.charCodeAt(r);return l.buffer}async function j(o,t){const n=localStorage.getItem("github_token");if(!n)throw new Error("No GitHub token found");return(await A.post("https://api.github.com/gists",{description:o,public:!0,files:{"problem-description.md":{content:t}}},{headers:{Authorization:`token ${n}`,Accept:"application/vnd.github.v3+json"}})).data}async function W(o,t){const n=localStorage.getItem("github_token");if(!n)throw new Error("No GitHub token found");return(await A.post(`${ce}/repos/${pe}/${me}/issues`,{title:o,body:t},{headers:{Authorization:`token ${n}`,Accept:"application/vnd.github.v3+json"}})).data}const Y=async()=>{if(!e.value.title.trim()||!e.value.readme.trim()){_.error("题目标题和描述不能为空");return}if(e.value.testCases.some(o=>!o.input.trim())){_.error("所有测试样例的输入不能为空");return}if(e.value.submitType===1&&!e.value.sourceCode.trim()){_.error("源代码不能为空");return}if(e.value.submitType===2&&e.value.testCases.some(o=>!o.output.trim())){_.error("所有测试样例的输出不能为空");return}L.value=!0;try{const o={id:N.value+1,title:e.value.title,memoryLimit:e.value.memoryLimit,timeLimit:e.value.timeLimit,difficulty:e.value.difficulty,author:oe().login,specialJudge:e.value.useSpecialJudge?1:0};let t=JSON.stringify(o)+`
---SEPARATOR---
`;t+=e.value.readme+`
---SEPARATOR---
`,e.value.submitType===1?(t+=`---SOURCE---
`,t+=e.value.sourceCode+`
---INPUTS---
`,e.value.testCases.forEach((r,d)=>{t+=r.input+`
`,d<e.value.testCases.length-1&&(t+=`---CASE---
`)})):e.value.testCases.forEach((r,d)=>{t+=r.input+`
---OUTPUT---
`,t+=r.output,d<e.value.testCases.length-1&&(t+=`
---CASE---
`)}),t+=`
---SEPARATOR---
`,e.value.useSpecialJudge&&(t+=e.value.specialJudgeCode);const n=await F(t),l=await j(e.value.title,n);await W(`新题目提交: ${e.value.title}`,l.files["problem-description.md"].raw_url),_.success("题目提交成功"),M.push("/")}catch(o){console.error("Failed to submit problem:",o),_.error("提交失败")}finally{L.value=!1}},Q=async()=>{try{const t=(await A.get("/problems/list.txt")).data.split(`
`).filter(l=>l.trim()),n=await Promise.all(t.map(async l=>(await A.get(`/problems/${l}/problem.json`)).data));$.value=n.sort((l,r)=>r.id-l.id),N.value=n.length}catch(o){console.error("Failed to load problems:",o)}};Z(()=>{Q(),e.value.submitType===1&&(i=S.create(k.value,{...C,language:"cpp",value:e.value.sourceCode}),i.onDidChangeModelContent(()=>{e.value.sourceCode=i.getValue()})),f=S.create(P.value,{...C,language:"markdown",value:e.value.readme}),f.onDidChangeModelContent(()=>{e.value.readme=f.getValue()}),window.addEventListener("resize",I)});const I=()=>{i&&i.layout(),f&&f.layout(),p&&p.layout()};return ee(()=>{i&&i.dispose(),f&&f.dispose(),p&&p.dispose(),window.removeEventListener("resize",I)}),(o,t)=>{const n=c("el-input"),l=c("el-form-item"),r=c("el-input-number"),d=c("el-option"),U=c("el-select"),v=c("el-radio"),K=c("el-radio-group"),T=c("el-switch"),h=c("el-icon"),m=c("el-button"),w=c("el-form");return b(),R("div",re,[a(w,{model:e.value,"label-width":"120px"},{default:u(()=>[a(l,{label:"题目标题",required:""},{default:u(()=>[a(n,{modelValue:e.value.title,"onUpdate:modelValue":t[0]||(t[0]=s=>e.value.title=s),placeholder:"请输入题目标题"},null,8,["modelValue"])]),_:1}),a(l,{label:"内存限制(MB)"},{default:u(()=>[a(r,{modelValue:e.value.memoryLimit,"onUpdate:modelValue":t[1]||(t[1]=s=>e.value.memoryLimit=s),min:1,max:1024,"controls-position":"right"},null,8,["modelValue"])]),_:1}),a(l,{label:"时间限制(ms)"},{default:u(()=>[a(r,{modelValue:e.value.timeLimit,"onUpdate:modelValue":t[2]||(t[2]=s=>e.value.timeLimit=s),min:100,max:1e4,step:100,"controls-position":"right"},null,8,["modelValue"])]),_:1}),a(l,{label:"难度设置",required:""},{default:u(()=>[a(U,{modelValue:e.value.difficulty,"onUpdate:modelValue":t[3]||(t[3]=s=>e.value.difficulty=s),placeholder:"请选择题目难度"},{default:u(()=>[a(d,{label:"简单",value:"easy"}),a(d,{label:"中等",value:"medium"}),a(d,{label:"困难",value:"hard"})]),_:1},8,["modelValue"])]),_:1}),a(l,{label:"提交方式"},{default:u(()=>[a(K,{modelValue:e.value.submitType,"onUpdate:modelValue":t[4]||(t[4]=s=>e.value.submitType=s)},{default:u(()=>[a(v,{label:1},{default:u(()=>t[6]||(t[6]=[V("提供源代码")])),_:1}),a(v,{label:2},{default:u(()=>t[7]||(t[7]=[V("提供输入输出")])),_:1})]),_:1},8,["modelValue"])]),_:1}),e.value.submitType===1?(b(),x(l,{key:0,label:"源代码",required:""},{default:u(()=>[g("div",{class:"editor-container",ref_key:"sourceCodeEditorContainer",ref:k},null,512)]),_:1})):B("",!0),a(l,{label:"题目描述",required:""},{default:u(()=>[g("div",{class:"editor-container",ref_key:"readmeEditorContainer",ref:P},null,512)]),_:1}),a(l,{label:"Special Judge"},{default:u(()=>[a(T,{modelValue:e.value.useSpecialJudge,"onUpdate:modelValue":t[5]||(t[5]=s=>e.value.useSpecialJudge=s)},null,8,["modelValue"])]),_:1}),e.value.useSpecialJudge?(b(),x(l,{key:1,label:"Special Judge代码(C/C++)",required:""},{default:u(()=>[g("div",{class:"editor-container",ref_key:"specialJudgeEditorContainer",ref:O},null,512)]),_:1})):B("",!0),a(l,{label:"测试样例"},{default:u(()=>[g("div",ie,[(b(!0),R(te,null,ae(e.value.testCases,(s,J)=>(b(),R("div",{key:J,class:"test-case"},[g("div",de,[g("h4",null,"测试样例 #"+ne(J+1),1),a(m,{type:"danger",size:"small",circle:"",onClick:E=>G(J),class:"remove-button",disabled:e.value.testCases.length<=1},{default:u(()=>[a(h,null,{default:u(()=>[a(se(ue))]),_:1})]),_:2},1032,["onClick","disabled"])]),a(n,{modelValue:s.input,"onUpdate:modelValue":E=>s.input=E,type:"textarea",rows:4,placeholder:"输入样例"},null,8,["modelValue","onUpdate:modelValue"]),e.value.submitType===2?(b(),x(n,{key:0,modelValue:s.output,"onUpdate:modelValue":E=>s.output=E,type:"textarea",rows:4,placeholder:"输出样例",class:"output-textarea"},null,8,["modelValue","onUpdate:modelValue"])):B("",!0)]))),128))]),a(m,{type:"primary",onClick:q,class:"add-button"},{default:u(()=>t[8]||(t[8]=[V(" 添加测试样例 ")])),_:1})]),_:1}),a(l,null,{default:u(()=>[a(m,{type:"primary",onClick:Y,loading:L.value},{default:u(()=>t[9]||(t[9]=[V(" 提交 ")])),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])])}}},_e=X(fe,[["__scopeId","data-v-2dbf80c2"]]);export{_e as default};
