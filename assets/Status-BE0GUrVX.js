import{_ as ee,e as p,k as W,q as te,f as ae,v as le,c as oe,a as s,w as c,r as d,o as se,b as C,d as V,t as A,p as j}from"./index-B_4hclnD.js";import{a as G}from"./axios-DXsv3KKR.js";const ne={class:"status"},re={class:"header"},ue={class:"filters"},ie=["href"],ce=["href"],de={class:"pagination"},H="xqy2006",B="Serverless-OJ",pe={__name:"Status",setup(me){const v=p(""),f=p(""),_=p(1),i=p(10),L=p(0),g=p([]),z=p([]),P=p(!1),I=p(!1),R=p(0),x=p(!1),S=localStorage.getItem("github_token");let T=null;const b=JSON.parse(localStorage.getItem("problemIdCache"))||{},y={},U=async a=>{const e=k(a.title);return b[e]?b[e]:y[e]?(await y[e],b[e]):(y[e]=G.get(`/problems/${e}/problem.json`).then(l=>{const t=l.data.id;b[e]=t,localStorage.setItem("problemIdCache",JSON.stringify(b))}).catch(l=>{console.error("获取问题 ID 失败:",l),b[e]=null}).finally(()=>{delete y[e]}),await y[e],b[e])},k=a=>a.slice(0,-2),$=async(a=1,e=100)=>{try{const l=`repo:${H}/${B} is:issue "评测" in:title`,t={Accept:"application/vnd.github.v3+json",...S&&{Authorization:`token ${S}`}},o=await fetch(`https://api.github.com/search/issues?q=${encodeURIComponent(l)}&page=${a}&per_page=${e}&sort=created&order=desc`,{headers:t});if(!o.ok)throw new Error("Network response was not ok");const u=await o.json();return{items:u.items,total:u.total_count}}catch(l){return console.error("获取提交记录失败:",l),{items:[],total:0}}},D=async(a=!1)=>{try{P.value=!0;const{total:e}=await $(1,1),l=e!==L.value;if(!l&&!a){await O();return}L.value=e;const t=(_.value-1)*i.value,o=t+i.value,u=Math.floor(t/i.value)+1,n=Math.ceil(o/i.value);let m=[];for(let w=u;w<=n;w++){const M=await $(w,i.value);m=[...m,...M.items]}const h=m.slice(t-(u-1)*i.value,o-(u-1)*i.value),E=await Promise.all(h.map(w=>U(w))),N=await J(h,E);g.value=N,!x.value&&l&&Q(n+1)}catch(e){console.error("获取提交记录失败:",e)}finally{P.value=!1}},J=async(a,e)=>a.filter(l=>l.title.endsWith("评测")).map((l,t)=>{var o;return{id:String(l.number),problemId:e[t],html_url:l.html_url,problem:k(l.title),user:l.user.login,result:((o=l.labels.find(u=>["AC","WA","CE","RE","TLE","MLE","CHEATING"].includes(u.name)))==null?void 0:o.name)||"评测中",submitTime:new Date(l.created_at).toLocaleString()}}),O=async()=>{const a=q.value,e=await Promise.all(a.map(async t=>{var o;try{if(t.result=="评测中"){const n=((o=(await G.get(`https://api.github.com/repos/${H}/${B}/issues/${t.id}`,{headers:{Authorization:`token ${S}`,Accept:"application/vnd.github.v3+json"}})).data.labels.find(m=>["AC","WA","CE","RE","TLE","MLE","CHEATING"].includes(m.name)))==null?void 0:o.name)||"评测中";return{...t,result:n}}else return{...t,result:t.result}}catch(u){return console.error(`更新Issue ${t.id}状态失败:`,u),t}})),l=[...g.value];e.forEach(t=>{const o=l.findIndex(u=>u.id===t.id);o!==-1&&(l[o]=t)}),g.value=l},Q=async a=>{try{x.value=!0;const e=Math.ceil(L.value/i.value);for(let l=a;l<=e;l++){const t=await $(l,i.value),o=await Promise.all(t.items.map(n=>U(n))),u=t.items.filter(n=>n.title.endsWith("评测")).map((n,m)=>{var h;return{id:String(n.number),problemId:o[m],html_url:n.html_url,problem:k(n.title),user:n.user.login,result:((h=n.labels.find(E=>["AC","WA","CE","RE","TLE","MLE","CHEATING"].includes(E.name)))==null?void 0:h.name)||"评测中",submitTime:new Date(n.created_at).toLocaleString()}});g.value=[...g.value,...u],R.value=Math.round((l-a+1)/(e-a+1)*100)}}catch(e){console.error("加载剩余数据失败:",e)}finally{x.value=!1,R.value=100}},q=W(()=>{let a=[...g.value];if(f.value&&(a=a.filter(t=>t.result===f.value)),v.value){const t=v.value.toLowerCase();a=a.filter(o=>o.problem.toLowerCase().includes(t)||o.id.includes(t)||o.user.toLowerCase().includes(t))}if(I.value){const t=j().login;a=a.filter(o=>o.user===t)}const e=(_.value-1)*i.value,l=e+i.value;return z.value=a.slice(e,l),z.value}),K=W(()=>{let a=[...g.value];if(f.value&&(a=a.filter(e=>e.result===f.value)),v.value){const e=v.value.toLowerCase();a=a.filter(l=>l.problem.toLowerCase().includes(e)||l.id.includes(e)||l.user.toLowerCase().includes(e))}if(I.value){const e=j().login;a=a.filter(l=>l.user===e)}return a.length});te([v,f,I],()=>{_.value=1});const X=a=>{i.value=a,_.value=1},Y=a=>{_.value=a},Z=a=>({AC:"success",CE:"info",RE:"danger",TLE:"warning",MLE:"primary",CHEATING:"danger",WA:"danger",评测中:""})[a];return ae(()=>{D(!0),S&&(T=setInterval(()=>{D(!1)},5e3))}),le(()=>{T&&clearInterval(T)}),(a,e)=>{const l=d("el-input"),t=d("el-option"),o=d("el-select"),u=d("el-checkbox"),n=d("el-table-column"),m=d("router-link"),h=d("el-tag"),E=d("el-table"),N=d("el-pagination"),w=d("el-card"),M=d("el-col"),F=d("el-row");return se(),oe("div",ne,[s(F,{justify:"center"},{default:c(()=>[s(M,{xs:24,sm:22,md:20},{default:c(()=>[s(w,{class:"status-card"},{header:c(()=>[C("div",re,[e[6]||(e[6]=C("h2",null,"评测状态",-1)),C("div",ue,[s(l,{modelValue:v.value,"onUpdate:modelValue":e[0]||(e[0]=r=>v.value=r),placeholder:"搜索题目/提交ID/用户","prefix-icon":"Search",class:"filter-item"},null,8,["modelValue"]),s(o,{modelValue:f.value,"onUpdate:modelValue":e[1]||(e[1]=r=>f.value=r),placeholder:"评测结果",class:"filter-item"},{default:c(()=>[s(t,{label:"全部",value:""}),s(t,{label:"通过",value:"AC"}),s(t,{label:"答案错误",value:"WA"}),s(t,{label:"编译错误",value:"CE"}),s(t,{label:"运行错误",value:"RE"}),s(t,{label:"超时",value:"TLE"}),s(t,{label:"内存超限",value:"MLE"}),s(t,{label:"作弊",value:"CHEATING"})]),_:1},8,["modelValue"]),s(u,{modelValue:I.value,"onUpdate:modelValue":e[2]||(e[2]=r=>I.value=r),class:"filter-item"},{default:c(()=>e[5]||(e[5]=[V(" 只看我的 ")])),_:1},8,["modelValue"])])])]),default:c(()=>[s(E,{data:q.value,style:{width:"100%"},class:"responsive-table"},{default:c(()=>[s(n,{prop:"id",label:"提交ID","min-width":"90"},{default:c(r=>[C("a",{href:r.row.html_url,target:"_blank"},A(r.row.id),9,ie)]),_:1}),s(n,{prop:"problem",label:"题目","min-width":"120"},{default:c(r=>[s(m,{to:`/submit/${r.row.problemId}`},{default:c(()=>[V(A(r.row.problem),1)]),_:2},1032,["to"])]),_:1}),s(n,{prop:"result",label:"结果","min-width":"90"},{default:c(r=>[s(h,{type:Z(r.row.result)},{default:c(()=>[V(A(r.row.result),1)]),_:2},1032,["type"])]),_:1}),s(n,{prop:"user",label:"提交用户","min-width":"100"},{default:c(r=>[C("a",{href:`https://github.com/${r.row.user}`,target:"_blank"},A(r.row.user),9,ce)]),_:1}),s(n,{prop:"submitTime",label:"提交时间","min-width":"160"})]),_:1},8,["data"]),C("div",de,[s(N,{"current-page":_.value,"onUpdate:currentPage":e[3]||(e[3]=r=>_.value=r),"page-size":i.value,"onUpdate:pageSize":e[4]||(e[4]=r=>i.value=r),total:K.value,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next",onSizeChange:X,onCurrentChange:Y,class:"responsive-pagination"},null,8,["current-page","page-size","total"])])]),_:1})]),_:1})]),_:1})])}}},_e=ee(pe,[["__scopeId","data-v-675a3f2d"]]);export{_e as default};
